<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Arunika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e0e0e0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-container { background-color: #1f1f1f; padding: 2rem; border-radius: 1.5rem; max-width: 90%; width: 24rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .input-group { display: flex; align-items: center; gap: 0.5rem; }
        .table-container { overflow-x: auto; }
        .admin-nav-btn { transition: all 0.2s ease-in-out; }
        .admin-nav-btn.active { background-color: #D97706; color: white; }
        .admin-nav-btn:not(.active) { background-color: #374151; }
        .admin-nav-btn:not(.active):hover { background-color: #4B5563; }
        .form-input { background-color: #374151; border: 1px solid #4B5563; border-radius: 0.5rem; padding: 0.75rem 1rem; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: #F59E0B; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5); }
        .action-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; color: white; transition: background-color 0.2s; }
        .btn-edit { background-color: #D97706; } .btn-edit:hover { background-color: #B45309; }
        .btn-delete { background-color: #DC2626; } .btn-delete:hover { background-color: #B91C1C; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header .flex:hover { color: #F59E0B; }
        .pagination-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; background-color: #374151; transition: background-color 0.2s; }
        .pagination-btn:hover:not(:disabled) { background-color: #4b5563; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-gray-800 p-6 md:p-10 rounded-3xl shadow-2xl">
        <header class="text-center mb-6 relative">
            <h1 class="text-3xl font-bold text-amber-500">Panel Admin Arunika</h1>
            <p class="text-md text-gray-400">Kelola Produk Jastip & Via Online</p>
            <p id="user-id" class="mt-2 text-xs text-gray-500 break-all"></p>
            <button id="logout-btn" class="absolute top-2 right-2 p-2 bg-gray-700 rounded-lg hover:bg-red-500 hidden"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></button>
        </header>

        <div id="loading-container" class="text-center p-8"><div class="animate-spin rounded-full h-12 w-12 border-4 border-amber-500 border-t-transparent mx-auto"></div><p class="mt-4">Memuat data...</p></div>
        <div id="login-container" class="hidden"><h2 class="text-2xl font-bold text-center mb-4">Login Admin</h2><form id="login-form" class="space-y-4 p-6 bg-gray-900 rounded-lg max-w-sm mx-auto"><div><label for="login-email" class="block text-sm font-medium mb-1">Email</label><input type="email" id="login-email" required class="w-full form-input"></div><div><label for="login-password" class="block text-sm font-medium mb-1">Kata Sandi</label><input type="password" id="login-password" required class="w-full form-input"></div><button type="submit" class="w-full py-3 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg">Masuk</button></form></div>

        <div id="admin-content" class="hidden">
            <nav class="flex justify-center space-x-2 mb-6 p-1 bg-black/20 rounded-xl">
                <button id="tab-jastip" class="admin-nav-btn active py-2 px-4 rounded-lg font-medium flex-1">Admin Jastip</button>
                <button id="tab-via-online" class="admin-nav-btn py-2 px-4 rounded-lg font-medium flex-1">Admin Via Online</button>
            </nav>

            <div id="content-jastip">
                <section class="mb-8 p-6 bg-black/20 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Kelola Produk Jastip</h2>
                    <form id="jastip-form" class="space-y-4"><input type="hidden" id="jastip-product-id"><div><label for="jastip-product-name" class="block text-sm font-medium mb-1">Nama Produk</label><input type="text" id="jastip-product-name" required class="w-full form-input"></div><div><label for="jastip-product-category" class="block text-sm font-medium mb-1">Kategori</label><select id="jastip-product-category" required class="w-full form-input"><option value="">Memuat kategori...</option></select></div><div id="jastip-coffee-fields" class="hidden"><div id="jastip-sub-category-container"><label for="jastip-product-sub-category" class="block text-sm font-medium mb-1">Sub-Kategori Kopi</label><select id="jastip-product-sub-category" class="w-full form-input"><option value="Arabika">Arabika</option><option value="Robusta">Robusta</option></select></div><div id="jastip-options-container" class="space-y-2 mt-4"></div><button type="button" id="jastip-add-option-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">Tambah Varian</button></div><div id="jastip-non-coffee-fields" class="hidden"><div><label for="jastip-product-price" class="block text-sm font-medium mb-1">Harga</label><input type="number" id="jastip-product-price" class="w-full form-input"></div><div><label for="jastip-product-shopee-link" class="block text-sm font-medium mb-1">Link Shopee (Opsional)</label><input type="url" id="jastip-product-shopee-link" class="w-full form-input"></div></div><div class="pt-2"><label for="jastip-product-is-best-seller" class="flex items-center space-x-2"><input type="checkbox" id="jastip-product-is-best-seller" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-amber-600"><span class="text-sm font-medium">Jadikan Produk Terlaris</span></label></div><div class="flex space-x-4 pt-2"><button type="submit" class="flex-1 py-3 bg-amber-600 hover:bg-amber-700 rounded-lg font-bold">Simpan Produk Jastip</button><button type="button" id="jastip-cancel-edit-btn" class="hidden flex-1 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold">Batal</button></div></form>
                </section>
                <hr class="my-10 border-t border-gray-700">
                <section class="p-6 bg-black/20 rounded-lg">
                    <h2 class="text-2xl font-bold mb-4">Kelola Kategori Jastip</h2>
                    <div class="space-y-4 md:space-y-0 md:flex md:gap-4 md:items-end mb-6 bg-gray-900/50 p-4 rounded-lg">
                        <div class="flex-grow"><label for="new-category-name" class="block text-sm font-medium mb-1">Nama Kategori Baru</label><input type="text" id="new-category-name" placeholder="cth: Aksesoris" class="w-full form-input"></div>
                        <div class="w-full md:w-32"><label for="new-category-order" class="block text-sm font-medium mb-1">Urutan</label><input type="number" id="new-category-order" placeholder="cth: 1" class="w-full form-input"></div>
                        <div class="flex items-center pb-2.5"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="new-category-hassubtabs" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-amber-600"><span>Punya Sub-Tab Kopi?</span></label></div>
                        <button id="add-category-btn" class="w-full md:w-auto py-2.5 px-6 bg-green-600 hover:bg-green-700 rounded-lg font-bold">Tambah</button>
                    </div>
                    <div id="category-list" class="space-y-2"></div>
                </section>
                <hr class="my-10 border-t border-gray-700">
                <div class="p-6 bg-black/20 rounded-lg"><h3 class="text-lg font-bold mb-4">Daftar Produk Jastip</h3><div class="relative mb-4"><input type="text" id="jastip-search-input" placeholder="Cari produk jastip..." class="w-full form-input"></div><div class="table-container"><table class="w-full text-left table-auto"><thead><tr class="bg-gray-900/50 text-gray-300 uppercase text-xs tracking-wider"><th class="p-3 sortable-header" data-sort-column="name"><div class="flex items-center gap-1">Nama<span id="jastip-name-sort-indicator"></span></div></th><th class="p-3">Kategori</th><th class="p-3 sortable-header" data-sort-column="timestamp"><div class="flex items-center gap-1">Tanggal<span id="jastip-timestamp-sort-indicator"></span></div></th><th class="p-3 text-center">Aksi</th></tr></thead><tbody id="jastip-product-list" class="text-sm"></tbody></table></div><div id="jastip-pagination-controls" class="mt-4 flex justify-between items-center text-sm text-gray-400"></div></div>
                <hr class="my-10 border-t border-gray-700"><section class="p-6 bg-black/20 rounded-lg"><h2 class="text-2xl font-bold mb-4">Kelola Testimoni</h2><form id="testimonial-form" class="space-y-4"><input type="hidden" id="testimonial-id"><div><label for="testimonial-url" class="block text-sm font-medium mb-1">URL Gambar Testimoni</label><input type="url" id="testimonial-url" required class="w-full form-input"></div><div class="flex space-x-4"><button type="submit" class="flex-1 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-bold">Simpan Testimoni</button><button type="button" id="cancel-testimonial-edit-btn" class="hidden flex-1 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold">Batal</button></div></form><div class="mt-8"><h3 class="text-lg font-bold mb-2">Daftar Testimoni</h3><div id="testimonial-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div></div></section>
            </div>
            <div id="content-via-online" class="hidden">
                 <section class="p-6 bg-black/20 rounded-lg"><h2 class="text-2xl font-bold mb-4">Kelola Produk Via Online</h2><form id="online-form" class="space-y-4"><input type="hidden" id="online-product-id"><div><label for="online-product-name" class="block text-sm font-medium mb-1">Nama Produk</label><input type="text" id="online-product-name" required class="w-full form-input"></div><div><label for="online-product-category" class="block text-sm font-medium mb-1">Kategori</label><input type="text" id="online-product-category" required class="w-full form-input"></div><div><label for="online-product-image-url" class="block text-sm font-medium mb-1">URL Gambar</label><input type="url" id="online-product-image-url" required class="w-full form-input"></div><div><label for="online-product-affiliate-link" class="block text-sm font-medium mb-1">Link Affiliate</label><input type="url" id="online-product-affiliate-link" required class="w-full form-input"></div><div><label for="online-product-platform" class="block text-sm font-medium mb-1">Platform</label><select id="online-product-platform" required class="w-full form-input"><option>Shopee</option><option>Tokopedia</option><option>Lazada</option><option>Lainnya</option></select></div><div class="flex space-x-4 pt-2"><button type="submit" class="flex-1 py-3 bg-amber-600 hover:bg-amber-700 rounded-lg font-bold">Simpan Produk Online</button><button type="button" id="online-cancel-edit-btn" class="hidden flex-1 py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold">Batal</button></div></form></section>
                 <div class="mt-8 p-6 bg-black/20 rounded-lg"><h3 class="text-lg font-bold mb-4">Daftar Produk Via Online</h3><div class="relative mb-4"><input type="text" id="online-search-input" placeholder="Cari produk online..." class="w-full form-input"></div><div class="table-container"><table class="w-full text-left table-auto"><thead><tr class="bg-gray-900/50 text-gray-300 uppercase text-xs tracking-wider"><th class="p-3 sortable-header" data-sort-column="name"><div class="flex items-center gap-1">Nama<span id="online-name-sort-indicator"></span></div></th><th class="p-3 sortable-header" data-sort-column="category"><div class="flex items-center gap-1">Kategori<span id="online-category-sort-indicator"></span></div></th><th class="p-3 sortable-header" data-sort-column="platform"><div class="flex items-center gap-1">Platform<span id="online-platform-sort-indicator"></span></div></th><th class="p-3 text-center">Aksi</th></tr></thead><tbody id="online-product-list" class="text-sm"></tbody></table></div><div id="online-pagination-controls" class="mt-4 flex justify-between items-center text-sm text-gray-400"></div></div>
            </div>
        </div>
    </div>
    <div id="modal" class="hidden modal-overlay"><div class="modal-container"><h3 id="modal-title" class="text-xl font-bold mb-4 text-amber-400"></h3><p id="modal-message" class="text-gray-300 mb-6"></p><button id="modal-close-btn" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-lg">OK</button></div></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAdYbsk_p1mIvf7NXd2cLaQAFBP2mrxtuI", authDomain: "jastip-arunika.firebaseapp.com", projectId: "jastip-arunika", storageBucket: "jastip-arunika.appspot.com", messagingSenderId: "272195022487", appId: "1:272195022487:web:f9b3cfe42170c5bd6983d2" };
        const ADMIN_UID = 'nx8LoIzVIYWqeOOVh5hQlY8vP9r1';
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);

        // --- DOM Elements ---
        const loginContainer=document.getElementById('login-container'),adminContent=document.getElementById('admin-content'),loadingContainer=document.getElementById('loading-container'),userIdDisplay=document.getElementById('user-id'),logoutBtn=document.getElementById('logout-btn'),modal=document.getElementById('modal'),modalTitle=document.getElementById('modal-title'),modalMessage=document.getElementById('modal-message'),modalCloseBtn=document.getElementById('modal-close-btn');
        const tabJastip=document.getElementById('tab-jastip'),tabViaOnline=document.getElementById('tab-via-online'),contentJastip=document.getElementById('content-jastip'),contentViaOnline=document.getElementById('content-via-online');
        const jastipForm=document.getElementById('jastip-form'),jastipProductIdInput=document.getElementById('jastip-product-id'),jastipProductNameInput=document.getElementById('jastip-product-name'),jastipCategorySelect=document.getElementById('jastip-product-category'),jastipCoffeeFields=document.getElementById('jastip-coffee-fields'),jastipNonCoffeeFields=document.getElementById('jastip-non-coffee-fields'),jastipSubCategorySelect=document.getElementById('jastip-product-sub-category'),jastipOptionsContainer=document.getElementById('jastip-options-container'),jastipAddOptionBtn=document.getElementById('jastip-add-option-btn'),jastipPriceInput=document.getElementById('jastip-product-price'),jastipShopeeLinkInput=document.getElementById('jastip-product-shopee-link'),jastipBestSellerCheckbox=document.getElementById('jastip-product-is-best-seller'),jastipProductListTable=document.getElementById('jastip-product-list'),jastipCancelEditBtn=document.getElementById('jastip-cancel-edit-btn'),jastipSearchInput=document.getElementById('jastip-search-input'),jastipPaginationControls=document.getElementById('jastip-pagination-controls');
        const onlineForm=document.getElementById('online-form'),onlineProductIdInput=document.getElementById('online-product-id'),onlineProductNameInput=document.getElementById('online-product-name'),onlineProductCategoryInput=document.getElementById('online-product-category'),onlineProductImageUrlInput=document.getElementById('online-product-image-url'),onlineProductAffiliateLinkInput=document.getElementById('online-product-affiliate-link'),onlineProductPlatformSelect=document.getElementById('online-product-platform'),onlineProductListTable=document.getElementById('online-product-list'),onlineCancelEditBtn=document.getElementById('online-cancel-edit-btn'),onlineSearchInput=document.getElementById('online-search-input'),onlinePaginationControls=document.getElementById('online-pagination-controls');
        const newCategoryNameInput=document.getElementById('new-category-name'),newCategoryOrderInput=document.getElementById('new-category-order'),newCategoryHasSubtabsCheckbox=document.getElementById('new-category-hassubtabs'),addCategoryBtn=document.getElementById('add-category-btn'),categoryListDiv=document.getElementById('category-list');
        const testimonialForm=document.getElementById('testimonial-form'),testimonialIdInput=document.getElementById('testimonial-id'),testimonialUrlInput=document.getElementById('testimonial-url'),testimonialListDiv=document.getElementById('testimonial-list'),cancelTestimonialEditBtn=document.getElementById('cancel-testimonial-edit-btn');
        
        // --- State Management ---
        let jastipProductsData=[], onlineProductsData=[], jastipCategories=[];
        let jastipCurrentPage=1, jastipSortColumn='name', jastipSortDirection='asc';
        let onlineCurrentPage=1, onlineSortColumn='name', onlineSortDirection='asc';
        const rowsPerPage=10;

        // --- Core Logic (Auth, Tabs, Modal) ---
        onAuthStateChanged(auth, user => { if (user && user.uid === ADMIN_UID) { [logoutBtn, adminContent].forEach(e => e.classList.remove('hidden')); [loadingContainer, loginContainer].forEach(e => e.classList.add('hidden')); userIdDisplay.textContent = `UID: ${user.uid}`; listenForJastipCategories(); listenForJastipProducts(); listenForOnlineProducts(); listenForTestimonials(); } else { [logoutBtn, adminContent].forEach(e => e.classList.add('hidden')); loadingContainer.classList.add('hidden'); loginContainer.classList.remove('hidden'); } });
        document.getElementById('login-form').addEventListener('submit', async e => { 
            e.preventDefault(); 
            try { 
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); 
                // PENAMBAHAN: Tampilkan modal sukses setelah login berhasil
                showModal('Login Berhasil', 'Selamat datang, Admin! Anda akan diarahkan ke panel.');
            } catch(err) { 
                showModal('Gagal Login', 'Email atau kata sandi salah.'); 
            } 
        });
        logoutBtn.addEventListener('click', () => signOut(auth));
        modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));
        function showModal(title, msg) { modalTitle.textContent = title; modalMessage.textContent = msg; modal.classList.remove('hidden'); }
        tabJastip.addEventListener('click', () => { tabJastip.classList.add('active'); tabViaOnline.classList.remove('active'); contentJastip.classList.remove('hidden'); contentViaOnline.classList.add('hidden'); });
        tabViaOnline.addEventListener('click', () => { tabViaOnline.classList.add('active'); tabJastip.classList.remove('active'); contentViaOnline.classList.remove('hidden'); contentJastip.classList.add('hidden'); });

        const editIcon=`<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg><span>Edit</span>`;
        const deleteIcon=`<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg><span>Hapus</span>`;
        
        // --- Jastip Category Logic ---
        function listenForJastipCategories() { const q = query(collection(db, 'jastip_categories'), orderBy('order')); onSnapshot(q, (snapshot) => { jastipCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); categoryListDiv.innerHTML = ''; jastipCategories.forEach(cat => { const div = document.createElement('div'); div.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg'; div.innerHTML = `<div class="flex items-center gap-4"><span class="font-bold text-gray-400">#${cat.order}</span><span class="font-semibold">${cat.name}</span>${cat.hasSubtabs ? '<span class="text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full">Dengan Sub-Tab</span>' : ''}</div><button data-id="${cat.id}" class="action-btn btn-delete">${deleteIcon}</button>`; categoryListDiv.appendChild(div); }); const currentSelection = jastipCategorySelect.value; jastipCategorySelect.innerHTML = '<option value="">-- Pilih Kategori --</option>'; jastipCategories.forEach(cat => { const option = document.createElement('option'); option.value = cat.name; option.textContent = cat.name; jastipCategorySelect.appendChild(option); }); jastipCategorySelect.value = currentSelection; }); }
        addCategoryBtn.addEventListener('click', async () => { const name = newCategoryNameInput.value.trim(); const order = parseInt(newCategoryOrderInput.value); const hasSubtabs = newCategoryHasSubtabsCheckbox.checked; if (!name || isNaN(order)) return showModal('Error', 'Nama kategori dan urutan harus diisi.'); await addDoc(collection(db, 'jastip_categories'), { name, order, hasSubtabs }); newCategoryNameInput.value = ''; newCategoryOrderInput.value = ''; newCategoryHasSubtabsCheckbox.checked = false; showModal('Sukses', `Kategori "${name}" berhasil ditambahkan.`); });
        categoryListDiv.addEventListener('click', async (e) => { const target = e.target.closest('button'); if (target && target.matches('.btn-delete')) { const id = target.dataset.id; if (confirm('Yakin ingin menghapus kategori ini?')) { await deleteDoc(doc(db, 'jastip_categories', id)); showModal('Sukses', 'Kategori berhasil dihapus.'); } } });

        // --- Jastip Product Logic ---
        function updateJastipSortIndicators() { ['name', 'timestamp'].forEach(c => document.getElementById(`jastip-${c}-sort-indicator`).textContent = ''); const i = jastipSortDirection === 'asc' ? '▲' : '▼'; document.getElementById(`jastip-${jastipSortColumn}-sort-indicator`).textContent = i; }
        function renderJastipPagination(total) { jastipPaginationControls.innerHTML = ''; const tP = Math.ceil(total / rowsPerPage); if (tP <= 1) return; const pB = document.createElement('button'); pB.textContent = 'Sebelumnya'; pB.className = 'pagination-btn'; pB.disabled = jastipCurrentPage === 1; pB.addEventListener('click', () => { jastipCurrentPage--; updateJastipUI(); }); const pI = document.createElement('span'); pI.textContent = `Halaman ${jastipCurrentPage} dari ${tP}`; const nB = document.createElement('button'); nB.textContent = 'Berikutnya'; nB.className = 'pagination-btn'; nB.disabled = jastipCurrentPage === tP; nB.addEventListener('click', () => { jastipCurrentPage++; updateJastipUI(); }); jastipPaginationControls.append(pB, pI, nB); }
        function updateJastipUI() { const q = jastipSearchInput.value.toLowerCase(); let f = jastipProductsData.filter(p => p.name.toLowerCase().includes(q)); f.sort((a, b) => { const vA = a[jastipSortColumn], vB = b[jastipSortColumn]; let c = 0; if (jastipSortColumn === 'timestamp') { c = (vA?.seconds || 0) - (vB?.seconds || 0); } else { c = String(vA).localeCompare(String(vB)); } return jastipSortDirection === 'asc' ? c : -c; }); const s = (jastipCurrentPage - 1) * rowsPerPage; const p = f.slice(s, s + rowsPerPage); jastipProductListTable.innerHTML = ''; p.forEach((p, i) => { const r = document.createElement('tr'); const t = p.timestamp ? new Date(p.timestamp.seconds * 1000).toLocaleString('id-ID', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'N/A'; r.className = `border-b border-gray-700 hover:bg-amber-900/50 ${i % 2 === 0 ? 'bg-gray-800/50' : 'bg-transparent'}`; r.innerHTML = `<td class="p-3">${p.name}</td><td class="p-3">${p.category}${p.subCategory ? ` (${p.subCategory})` : ''}</td><td class="p-3 whitespace-nowrap">${t}</td><td class="p-3 text-center"><div class="flex items-center justify-center gap-2"><button data-id="${p.id}" class="action-btn btn-edit">${editIcon}</button><button data-id="${p.id}" class="action-btn btn-delete">${deleteIcon}</button></div></td>`; jastipProductListTable.appendChild(r); }); updateJastipSortIndicators(); renderJastipPagination(f.length); }
        function listenForJastipProducts() { onSnapshot(query(collection(db, 'products')), s => { jastipProductsData = s.docs.map(d => ({ id: d.id, ...d.data() })); updateJastipUI(); }); }
        document.querySelectorAll('#content-jastip .sortable-header').forEach(h => { h.addEventListener('click', () => { const c = h.dataset.sortColumn; if (jastipSortColumn === c) { jastipSortDirection = jastipSortDirection === 'asc' ? 'desc' : 'asc'; } else { jastipSortColumn = c; jastipSortDirection = 'asc'; } jastipCurrentPage = 1; updateJastipUI(); }); });
        jastipSearchInput.addEventListener('input', () => { jastipCurrentPage = 1; updateJastipUI(); });
        jastipCategorySelect.addEventListener('change', e => { const catHasSubtabs = jastipCategories.find(c => c.name === e.target.value)?.hasSubtabs; jastipCoffeeFields.classList.toggle('hidden', !catHasSubtabs); jastipNonCoffeeFields.classList.toggle('hidden', catHasSubtabs); });
        jastipAddOptionBtn.addEventListener('click', () => createJastipOptionInput()); function createJastipOptionInput(opt = { name: '', price: '' }) { const g = document.createElement('div'); g.className = 'input-group'; g.innerHTML = `<input value="${opt.name}" placeholder="Varian" class="w-full form-input"><input type="number" value="${opt.price}" placeholder="Harga" class="w-full form-input"><button type="button" class="text-red-500 p-2">&times;</button>`; jastipOptionsContainer.appendChild(g); g.querySelector('button').addEventListener('click', () => g.remove()); }
        jastipForm.addEventListener('submit', async e => { e.preventDefault(); const catName = jastipCategorySelect.value; const cat = jastipCategories.find(c => c.name === catName); if (!cat) return showModal('Error', 'Kategori tidak valid.'); let data; if (cat.hasSubtabs) { const opts = Array.from(jastipOptionsContainer.querySelectorAll('.input-group')).map(el => ({ name: el.children[0].value, price: parseInt(el.children[1].value), id: el.children[0].value.replace(/\s/g, '').toLowerCase() })); if (opts.some(o => !o.name || isNaN(o.price))) return showModal('Error', 'Varian kopi harus diisi lengkap.'); data = { options: opts, subCategory: jastipSubCategorySelect.value }; } else { data = { price: parseInt(jastipPriceInput.value), shopeeLink: jastipShopeeLinkInput.value }; } Object.assign(data, { name: jastipProductNameInput.value, category: catName, isBestSeller: jastipBestSellerCheckbox.checked, timestamp: serverTimestamp() }); try { if (jastipProductIdInput.value) await setDoc(doc(db, 'products', jastipProductIdInput.value), data); else await addDoc(collection(db, 'products'), data); showModal('Sukses', 'Produk Jastip disimpan!'); jastipForm.reset(); jastipCancelEditBtn.classList.add('hidden'); jastipOptionsContainer.innerHTML = ''; } catch (err) { showModal('Error', 'Gagal menyimpan.'); } });
        jastipProductListTable.addEventListener('click', e => { const id = e.target.closest('button')?.dataset.id; if (!id) return; if (e.target.closest('.btn-edit')) { const p = jastipProductsData.find(p => p.id === id); const cat = jastipCategories.find(c => c.name === p.category); jastipProductIdInput.value = id; jastipProductNameInput.value = p.name; jastipCategorySelect.value = p.category; jastipCoffeeFields.classList.toggle('hidden', !cat?.hasSubtabs); jastipNonCoffeeFields.classList.toggle('hidden', cat?.hasSubtabs); if (cat?.hasSubtabs) { jastipSubCategorySelect.value = p.subCategory; jastipOptionsContainer.innerHTML = ''; p.options.forEach(createJastipOptionInput); } else { jastipPriceInput.value = p.price; jastipShopeeLinkInput.value = p.shopeeLink || ''; } jastipBestSellerCheckbox.checked = p.isBestSeller; jastipCancelEditBtn.classList.remove('hidden'); contentJastip.scrollIntoView({ behavior: 'smooth' }); } if (e.target.closest('.btn-delete') && confirm('Yakin hapus?')) { deleteDoc(doc(db, 'products', id)); showModal('Sukses', 'Produk Jastip dihapus.'); } });
        jastipCancelEditBtn.addEventListener('click', () => { jastipForm.reset(); jastipOptionsContainer.innerHTML = ''; jastipCancelEditBtn.classList.add('hidden'); });

        // --- Via Online Logic ---
        function updateOnlineSortIndicators(){['name','category','platform'].forEach(c=>document.getElementById(`online-${c}-sort-indicator`).textContent='');const i=onlineSortDirection==='asc'?'▲':'▼';document.getElementById(`online-${onlineSortColumn}-sort-indicator`).textContent=i;}
        function renderOnlinePagination(total){onlinePaginationControls.innerHTML='';const tP=Math.ceil(total/rowsPerPage);if(tP<=1)return;const pB=document.createElement('button');pB.textContent='Sebelumnya';pB.className='pagination-btn';pB.disabled=onlineCurrentPage===1;pB.addEventListener('click',()=>{onlineCurrentPage--;updateOnlineUI();});const pI=document.createElement('span');pI.textContent=`Halaman ${onlineCurrentPage} dari ${tP}`;const nB=document.createElement('button');nB.textContent='Berikutnya';nB.className='pagination-btn';nB.disabled=onlineCurrentPage===tP;nB.addEventListener('click',()=>{onlineCurrentPage++;updateOnlineUI();});onlinePaginationControls.append(pB,pI,nB);}
        function updateOnlineUI(){const q=onlineSearchInput.value.toLowerCase();let f=onlineProductsData.filter(p=>p.name.toLowerCase().includes(q)||p.category.toLowerCase().includes(q));f.sort((a,b)=>{const vA=a[onlineSortColumn],vB=b[onlineSortColumn];const c=String(vA).localeCompare(String(vB));return onlineSortDirection==='asc'?c:-c;});const s=(onlineCurrentPage-1)*rowsPerPage;const p=f.slice(s,s+rowsPerPage);onlineProductListTable.innerHTML='';p.forEach((p,i)=>{const r=document.createElement('tr');r.className=`border-b border-gray-700 hover:bg-amber-900/50 ${i%2===0?'bg-gray-800/50':'bg-transparent'}`;r.innerHTML=`<td class="p-3">${p.name}</td><td class="p-3">${p.category}</td><td class="p-3">${p.platform}</td><td class="p-3 text-center"><div class="flex items-center justify-center gap-2"><button data-id="${p.id}" class="action-btn btn-edit">${editIcon}</button><button data-id="${p.id}" class="action-btn btn-delete">${deleteIcon}</button></div></td>`;onlineProductListTable.appendChild(r);});updateOnlineSortIndicators();renderOnlinePagination(f.length);}
        function listenForOnlineProducts(){onSnapshot(query(collection(db,'affiliate_products')),s=>{onlineProductsData=s.docs.map(d=>({id:d.id,...d.data()}));updateOnlineUI();});}
        document.querySelectorAll('#content-via-online .sortable-header').forEach(h=>{h.addEventListener('click',()=>{const c=h.dataset.sortColumn;if(onlineSortColumn===c){onlineSortDirection=onlineSortDirection==='asc'?'desc':'asc';}else{onlineSortColumn=c;onlineSortDirection='asc';}onlineCurrentPage=1;updateOnlineUI();});});
        onlineSearchInput.addEventListener('input',()=>{onlineCurrentPage=1;updateOnlineUI();});
        onlineForm.addEventListener('submit',async e=>{e.preventDefault();const data={name:onlineProductNameInput.value,category:onlineProductCategoryInput.value,imageUrl:onlineProductImageUrlInput.value,affiliateLink:onlineProductAffiliateLinkInput.value,platform:onlineProductPlatformSelect.value};const id=onlineProductIdInput.value;try{if(id)await setDoc(doc(db,'affiliate_products',id),data);else await addDoc(collection(db,'affiliate_products'),data);showModal('Sukses','Produk Online disimpan!');onlineForm.reset();onlineCancelEditBtn.classList.add('hidden');}catch(err){showModal('Error','Gagal menyimpan.');}});
        onlineProductListTable.addEventListener('click',e=>{const id=e.target.closest('button')?.dataset.id;if(!id)return;if(e.target.closest('.btn-edit')){const p=onlineProductsData.find(p=>p.id===id);onlineProductIdInput.value=id;onlineProductNameInput.value=p.name;onlineProductCategoryInput.value=p.category;onlineProductImageUrlInput.value=p.imageUrl;onlineProductAffiliateLinkInput.value=p.affiliateLink;onlineProductPlatformSelect.value=p.platform;onlineCancelEditBtn.classList.remove('hidden');contentViaOnline.scrollIntoView({behavior:'smooth'});}if(e.target.closest('.btn-delete')&&confirm('Yakin hapus?')){deleteDoc(doc(db,'affiliate_products',id));showModal('Sukses','Produk Online dihapus.');}});
        onlineCancelEditBtn.addEventListener('click',()=>{onlineForm.reset();onlineCancelEditBtn.classList.add('hidden');});

        // --- Testimonial Logic ---
        function listenForTestimonials(){onSnapshot(collection(db,'testimonials'),snap=>{testimonialListDiv.innerHTML='';snap.docs.forEach(d=>{const t={id:d.id,...d.data()};const div=document.createElement('div');div.className='relative group rounded-lg overflow-hidden';div.innerHTML=`<img src="${t.url}" class="w-full h-auto object-cover aspect-square"><div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button data-id="${t.id}" data-url="${t.url}" class="action-btn btn-edit">${editIcon}</button><button data-id="${t.id}" class="action-btn btn-delete">${deleteIcon}</button></div>`;testimonialListDiv.appendChild(div);});});}
        testimonialForm.addEventListener('submit',async e=>{e.preventDefault();const id=testimonialIdInput.value;try{if(id)await setDoc(doc(db,'testimonials',id),{url:testimonialUrlInput.value});else await addDoc(collection(db,'testimonials'),{url:testimonialUrlInput.value});showModal('Sukses','Testimoni disimpan!');testimonialForm.reset();cancelTestimonialEditBtn.classList.add('hidden');}catch(err){showModal('Error','Gagal simpan.');}});
        testimonialListDiv.addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const id=btn.dataset.id;if(btn.matches('.btn-edit')){testimonialIdInput.value=id;testimonialUrlInput.value=btn.dataset.url;cancelTestimonialEditBtn.classList.remove('hidden');}if(btn.matches('.btn-delete')&&confirm('Yakin hapus?')){deleteDoc(doc(db,'testimonials',id));showModal('Sukses','Testimoni dihapus.');}});
        cancelTestimonialEditBtn.addEventListener('click',()=>{testimonialForm.reset();cancelTestimonialEditBtn.classList.add('hidden');});
    </script>
</body>
</html>
