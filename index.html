<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arunika Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e0e0e0; }
        #main-title { font-family: 'Cinzel', serif; font-size: 3rem; color: #FFD700; }
        .product-card { transition: transform 0.2s ease, box-shadow 0.2s ease; padding: 1rem; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(255,215,0,0.1); }
        .product-name-best-seller { display: inline-block; background-image: linear-gradient(to right, #FFD700, #B8860B); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; padding: 0.25rem 0.5rem; border: 1px solid #FFD700; border-radius: 9999px; font-size: 0.75rem; }
        .main-nav-btn, .sub-tab-btn { background-color: #2a2a2a; color: #FFD700; transition: all 0.2s ease; }
        .main-nav-btn.active, .sub-tab-btn.active, .main-nav-btn:hover, .sub-tab-btn:hover { background-image: linear-gradient(to right, #B8860B, #FFD700); box-shadow: 0 4px 6px -1px rgba(255,215,0,0.1); color: #1a1a1a; }
        .golden-btn { background-color: #1a1a1a; color: #FFD700; border: 1px solid #FFD700; }
        .golden-btn:hover { background-image: linear-gradient(to right, #B8860B, #FFD700); color: #1a1a1a; }
        .testimonial-img { cursor: pointer; width: 100%; height: 120px; object-fit: cover; border-radius: 0.5rem; transition: transform 0.2s ease; }
        .testimonial-img:hover { transform: scale(1.05); }
        .shopee-btn { background-color: #FF5722; color: white; padding: .5rem 1rem; font-size: .75rem; border-radius: 9999px; }
        @keyframes pulse { 50% { opacity: .5; } }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* --- Gaya Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-container {
            background-color: #1f2937;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-container {
            transform: scale(1);
        }

        /* --- Gaya Panel Info --- */
        .info-panel-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            color: #d1d5db;
            transition: background-color 0.2s, color 0.2s;
            background-color: #1f2937;
        }
        .info-panel-btn:hover {
            background-color: #374151;
            color: #f59e0b;
        }
        .info-panel-btn svg {
            width: 1.75rem;
            height: 1.75rem;
        }
        .info-panel-btn span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        #category-selector-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #2a2a2a;
            border: 1px solid #4b5563;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }
        #category-selector-btn:hover {
            border-color: #FFD700;
        }
        .category-modal-item {
            text-align: left;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .category-modal-item.active {
            background-color: #4b5563;
            font-weight: bold;
            color: #FFD700;
        }
        .category-modal-item:not(.active):hover {
            background-color: #374151;
        }

        #toast-notification {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2a2a2a;
            color: #FFD700;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #FFD700;
            box-shadow: 0 4px 6px -1px rgba(255,215,0,0.1);
            z-index: 100;
            transition: bottom 0.5s ease-in-out;
            font-weight: 600;
        }
        #toast-notification.show {
            bottom: 20px;
        }

        /* Gaya untuk dropdown urutkan */
        .sort-select {
            background-color: #2a2a2a;
            border: 1px solid #4b5563;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #e0e0e0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-gray-800 p-6 md:p-10 rounded-3xl shadow-2xl">
        <header class="text-center mb-6">
            <h1 id="main-title" class="font-extrabold text-gray-200 mb-2 tracking-tight">Arunika Shop</h1>
            <p class="text-lg text-gray-400">Jastip & Rekomendasi Produk Pilihan</p>
        </header>
        <nav class="flex justify-center space-x-2 mb-6 p-1 bg-black/20 rounded-xl"><a href="index.html" class="main-nav-btn active py-2 px-4 rounded-lg font-medium flex-1 text-center">Jastip</a><a href="via_online.html" class="main-nav-btn py-2 px-4 rounded-lg font-medium flex-1 text-center">Via Online</a></nav>
        
        <main id="jastip-content">
            <section id="info-panel" class="mb-6">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <button id="how-to-order-btn" class="info-panel-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                        <span class="truncate">Cara Pesan</span>
                    </button>
                    <button id="best-seller-info-btn" class="info-panel-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2 3.5 9.5 6 22h12l2.5-12.5L12 2z"/><path d="m6 22 6-10 6 10"/><path d="M3.5 9.5h17"/></svg>
                        <span class="truncate">Best Seller</span>
                    </button>
                    <button id="testimonial-btn" class="info-panel-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.174 6.812a1 1 0 0 0-1.141-1.424l-8.58 3.432a1 1 0 0 0-.453.894v6.282a1 1 0 0 0 .953.996l3.432-.858a1 1 0 0 0 .894-.453l4.288-8.58a1 1 0 0 0-1.424-1.141Z"/><path d="M18 12.204v.996l-3.432.858a1 1 0 0 1-.894-.453L12.4 11.12a1 1 0 0 1 1.424-1.141l4.176 2.229Z"/><path d="m3 3 3 3"/><path d="M9 3l-3 3"/><path d="M3 9l3-3"/><path d="M3 15l3-3"/><path d="M15 3l-3 3"/></svg>
                        <span class="truncate">Testimoni</span>
                    </button>
                </div>
            </section>

            <section id="product-filters" class="grid md:grid-cols-2 gap-4 mb-6">
                <button id="category-selector-btn">
                    <span id="category-selector-text" class="font-bold text-amber-400">Memuat kategori...</span>
                    <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div>
                    <select id="sort-select" class="w-full sort-select">
                        <option value="default">Urutan Rekomendasi</option>
                        <option value="name-asc">Nama (A-Z)</option>
                        <option value="price-asc">Harga Terendah</option>
                        <option value="price-desc">Harga Tertinggi</option>
                    </select>
                </div>
            </section>

            <div id="tab-content">
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-4"><div class="skeleton h-48 bg-gray-700 rounded-xl"></div><div class="skeleton h-48 bg-gray-700 rounded-xl"></div><div class="skeleton h-48 bg-gray-700 rounded-xl hidden md:block"></div></div>
            </div>
        </main>
        
        <hr class="my-10 border-t border-gray-700">
        <section>
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Keranjang Anda</h2>
            <div id="cart-items" class="space-y-4 mb-4"><p id="empty-cart-message" class="text-gray-500 italic text-center p-4">Keranjang masih kosong.</p></div>
            <div class="flex justify-between items-center font-bold text-xl text-gray-200 border-t border-gray-700 pt-4"><span>Total:</span><span id="cart-total">Rp0</span></div>
            <button id="checkout-button" class="w-full mt-6 py-4 px-6 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-xl hidden">Pesan Sekarang via WhatsApp</button>
        </section>
        <hr class="my-10 border-t border-gray-700">
        <section id="suggestion-form-section" class="mb-8 p-6 bg-gray-900 rounded-lg">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Saran Barang & Estimasi Harga</h2>
            <p class="text-sm text-gray-400 mb-4">Anda bisa juga memesan barang yang tidak ada di list produk dan mengkonfirmasinya lewat WhatsApp.</p>
            <div class="flex flex-col space-y-4"><input type="text" id="suggestion-item-name" placeholder="Nama Barang" class="bg-gray-700 rounded-lg p-3"><input type="number" id="suggestion-item-price" placeholder="Harga perkiraan" class="bg-gray-700 rounded-lg p-3"><button id="send-suggestion-btn" class="golden-btn w-full py-3 font-bold rounded-lg">Kirim Saran via WhatsApp</button></div>
        </section>
        <hr class="my-10 border-t border-gray-700">
        <section id="testimonial-section" class="mb-8 scroll-mt-20">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Testimoni</h2>
            <div id="testimonial-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 p-4 bg-gray-900 rounded-lg"></div>
            <p id="testimonial-loading-message" class="text-center text-gray-500 mt-4">Memuat testimoni...</p>
        </section>
        <footer class="mt-8 text-center text-gray-500 text-sm"><p>Copyright &copy; by Arunika Shop 2025</p></footer>
    </div>
    
    <!-- --- Modals --- -->
    <div id="how-to-order-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-amber-400">Cara Pesan</h3><button class="close-modal text-gray-500 text-2xl hover:text-white">&times;</button></div>
            <div class="text-left text-gray-300 space-y-4">
                <div class="flex items-start gap-3"><div class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-amber-500/20 text-amber-400 rounded-full font-bold text-sm">1</div><p>Pilih produk & ukuran.</p></div>
                <div class="flex items-start gap-3"><div class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-amber-500/20 text-amber-400 rounded-full font-bold text-sm">2</div><p>Klik tombol "+ Tambah".</p></div>
                <div class="flex items-start gap-3"><div class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-amber-500/20 text-amber-400 rounded-full font-bold text-sm">3</div><p>Klik "Pesan Sekarang Via WhatsApp".</p></div>
                <div class="flex items-start gap-3"><div class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-amber-500/20 text-amber-400 rounded-full font-bold text-sm">4</div><p>Pesan otomatis terisi, tinggal kirim.</p></div>
            </div>
            <div class="mt-8"><button class="close-modal w-full py-2 px-6 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg">Mengerti</button></div>
        </div>
    </div>

    <div id="best-seller-info-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-amber-400">Info Best Seller</h3><button class="close-modal text-gray-500 text-2xl hover:text-white">&times;</button></div>
            <div class="text-center text-gray-300 space-y-4">
                <p>Produk dengan label nama keemasan seperti ini adalah produk favorit pelanggan kami.</p>
                <div class="flex justify-center p-4 bg-gray-900 rounded-lg"><h3 class="font-semibold product-name-best-seller px-4 py-1">Nama Produk Terlaris</h3></div>
            </div>
            <div class="mt-8"><button class="close-modal w-full py-2 px-6 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg">Ok, Paham</button></div>
        </div>
    </div>

    <div id="category-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-amber-400">Pilih Kategori</h3><button class="close-modal text-gray-500 text-2xl hover:text-white">&times;</button></div>
            <div id="category-modal-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <div id="image-modal" class="modal-overlay">
        <div class="relative max-w-4xl p-4 w-full h-full flex items-center justify-center">
            <button class="close-modal absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 leading-none z-10">&times;</button>
            <img id="full-image" class="max-w-full max-h-full object-contain" src="" alt="Testimoni">
        </div>
    </div>

    <!-- PENAMBAHAN: Modal baru untuk konfirmasi tambah barang -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-container text-center">
            <h3 class="text-xl font-bold text-amber-400 mb-4">Konfirmasi</h3>
            <p id="confirmation-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-add-btn" class="w-full py-2 px-6 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded-lg">Batal</button>
                <button id="confirm-add-btn" class="w-full py-2 px-6 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg">Ya, Tambahkan</button>
            </div>
        </div>
    </div>

    <div id="toast-notification">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAdYbsk_p1mIvf7NXd2cLaQAFBP2mrxtuI", authDomain: "jastip-arunika.firebaseapp.com", projectId: "jastip-arunika", storageBucket: "jastip-arunika.appspot.com", messagingSenderId: "272195022487", appId: "1:272195022487:web:f9b3cfe42170c5bd6983d2" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const tabContentContainer = document.getElementById('tab-content'), cartItemsDiv = document.getElementById('cart-items'), cartTotalSpan = document.getElementById('cart-total'), emptyCartMessage = document.getElementById('empty-cart-message'), checkoutButton = document.getElementById('checkout-button'), testimonialGrid = document.getElementById('testimonial-grid'), testimonialLoadingMessage = document.getElementById('testimonial-loading-message'), sendSuggestionBtn = document.getElementById('send-suggestion-btn'), howToOrderBtn = document.getElementById('how-to-order-btn'), bestSellerInfoBtn = document.getElementById('best-seller-info-btn'), testimonialBtn = document.getElementById('testimonial-btn');
        const howToOrderModal=document.getElementById('how-to-order-modal'),bestSellerInfoModal=document.getElementById('best-seller-info-modal'),imageModal=document.getElementById('image-modal');
        const categorySelectorBtn = document.getElementById('category-selector-btn'), categorySelectorText = document.getElementById('category-selector-text'), categoryModal = document.getElementById('category-modal'), categoryModalList = document.getElementById('category-modal-list');
        const toastNotification = document.getElementById('toast-notification'), toastMessage = document.getElementById('toast-message');
        const sortSelect = document.getElementById('sort-select');
        
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmAddBtn = document.getElementById('confirm-add-btn');
        const cancelAddBtn = document.getElementById('cancel-add-btn');

        let allProducts = [], allCategories = [], cart = {}, itemToConfirm = null, currentSort = 'default';
        const titipFee = 25000, whatsappNumber = '6285640312607';

        let toastTimeout;
        function showToast(message) {
            clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            toastNotification.classList.add('show');
            toastTimeout = setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000);
        }

        function activateCategory(categoryName) {
            categorySelectorText.textContent = categoryName;
            document.querySelectorAll('.category-modal-item').forEach(item => {
                const checkIcon = item.querySelector('svg');
                item.classList.toggle('active', item.dataset.category === categoryName);
                if (checkIcon) checkIcon.classList.toggle('hidden', item.dataset.category !== categoryName);
            });
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            const targetId = `content-${categoryName.toLowerCase().replace(/\s/g, '-')}`;
            document.getElementById(targetId)?.classList.remove('hidden');
        }
        
        // Fungsi untuk mendapatkan harga representatif dari produk untuk sorting
        function getProductPrice(product) {
            if (product.price) {
                return product.price;
            }
            if (product.options && product.options.length > 0) {
                // Menggunakan harga terendah dari varian sebagai acuan
                return Math.min(...product.options.map(o => o.price));
            }
            return 0; // Produk tanpa harga akan ditaruh di awal
        }

        function renderUI(categories, products) {
            tabContentContainer.innerHTML = '';
            categoryModalList.innerHTML = '';

            // Lakukan sorting produk sebelum dirender
            let sortedProducts = [...products];
            switch (currentSort) {
                case 'name-asc':
                    sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'price-asc':
                    sortedProducts.sort((a, b) => getProductPrice(a) - getProductPrice(b));
                    break;
                case 'price-desc':
                    sortedProducts.sort((a, b) => getProductPrice(b) - getProductPrice(a));
                    break;
                // 'default' tidak melakukan apa-apa, menggunakan urutan dari Firestore
            }

            categories.forEach(cat => {
                const catId = cat.name.toLowerCase().replace(/\s/g, '-');
                const pane = document.createElement('div');
                pane.id = `content-${catId}`;
                pane.className = 'tab-pane hidden';
                const productsForCat = sortedProducts.filter(p => p.category === cat.name);
                
                if (cat.hasSubtabs) {
                    const arabikaProducts = productsForCat.filter(p => p.subCategory === "Arabika");
                    const robustaProducts = productsForCat.filter(p => p.subCategory === "Robusta");
                    pane.innerHTML = `<div class="flex space-x-2 mb-4 p-1 bg-gray-900 rounded-xl"><button class="sub-tab-btn active w-full py-2 rounded-lg" data-subcat="arabika">Arabika</button><button class="sub-tab-btn w-full py-2 rounded-lg" data-subcat="robusta">Robusta</button></div><div><section id="content-${catId}-arabika"><h2 class="text-2xl font-bold mb-4">Arabika</h2><div id="${catId}-arabika-list" class="product-list grid grid-cols-2 lg:grid-cols-3 gap-4"></div></section><section id="content-${catId}-robusta" class="hidden"><h2 class="text-2xl font-bold mb-4">Robusta</h2><div id="${catId}-robusta-list" class="product-list grid grid-cols-2 lg:grid-cols-3 gap-4"></div></section></div>`;
                    tabContentContainer.appendChild(pane);
                    renderProducts(arabikaProducts, document.getElementById(`${catId}-arabika-list`));
                    renderProducts(robustaProducts, document.getElementById(`${catId}-robusta-list`));
                } else {
                    pane.innerHTML = `<section><h2 class="text-2xl font-bold mb-4">${cat.name}</h2><div id="${catId}-list" class="product-list grid grid-cols-2 lg:grid-cols-3 gap-4"></div></section>`;
                    tabContentContainer.appendChild(pane);
                    renderProducts(productsForCat, document.getElementById(`${catId}-list`));
                }
            });
            
            categories.forEach(cat => {
                const item = document.createElement('button');
                item.className = 'category-modal-item';
                item.dataset.category = cat.name;
                item.innerHTML = `<span>${cat.name}</span> <svg class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                item.addEventListener('click', () => {
                    activateCategory(cat.name);
                    hideModal(categoryModal);
                });
                categoryModalList.appendChild(item);
            });

            if (categories.length > 0) {
                activateCategory(categories[0].name);
            } else {
                categorySelectorText.textContent = "Belum ada kategori";
            }
            addTabEventListeners();
        }

        function renderProducts(products, container) {
            if (!container) return;
            container.innerHTML = '';
            products.forEach(p => container.appendChild(createProductCard(p)));
        }

        function createProductCard(product) {
            const el = document.createElement('div'); el.className = 'product-card bg-gray-700 rounded-xl shadow-md border border-gray-600';
            const isBestSellerClass = product.isBestSeller ? 'product-name-best-seller' : ''; let actionsHtml = '';
            if (product.options && product.options.length > 0) {
                const options = product.options.map(o => `<option value="${product.id}-${o.id}">${o.name} - Rp${o.price.toLocaleString('id-ID')}</option>`).join('');
                actionsHtml = `<div class="product-actions-container"><select id="select-${product.id}" class="w-full text-sm bg-gray-600 rounded-lg p-2">${options}</select><button data-id="${product.id}" class="add-to-cart-btn-multi bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 text-sm rounded-full mt-2 w-full">+ Tambah</button></div>`;
            } else {
                const price = product.price ? `<p class="text-amber-500 font-bold text-sm">Rp${product.price.toLocaleString('id-ID')}</p>` : '';
                const shopee = product.shopeeLink ? `<a href="${product.shopeeLink}" target="_blank" class="shopee-btn">Beli di Shopee</a>` : '';
                actionsHtml = `<div class="product-actions-container">${price}<button data-id="${product.id}" class="add-to-cart-btn-single bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 text-sm rounded-full mt-2 w-full">+ Tambah</button>${shopee}</div>`;
            }
            el.innerHTML = `<div class="relative w-full flex flex-col items-center"><div class="icon-container mb-2 text-2xl text-amber-500">🛍️</div><div class="product-info flex-1 w-full truncate mb-2 text-center"><h3 class="font-semibold text-base text-gray-200 truncate ${isBestSellerClass}">${product.name}</h3></div></div><div class="product-actions-wrapper w-full">${actionsHtml}</div>`;
            return el;
        }

        function renderCart() {
            cartItemsDiv.innerHTML = ''; let total = 0; let hasItems = Object.keys(cart).length > 0;
            for (const id in cart) { const item = cart[id]; total += item.price * item.quantity; const el = document.createElement('div'); el.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-lg'; el.innerHTML = `<div class="flex items-center space-x-3"><button data-id="${id}" class="remove-from-cart-btn bg-red-500 w-6 h-6 rounded-full">-</button><span>${item.quantity}x ${item.name}</span></div><span class="font-semibold text-amber-500">Rp${(item.price*item.quantity).toLocaleString('id-ID')}</span>`; cartItemsDiv.appendChild(el); }
            if(hasItems){ total+=titipFee; const feeEl=document.createElement('div'); feeEl.className='flex justify-between items-center p-3 bg-gray-700 rounded-lg font-bold'; feeEl.innerHTML=`<span>Jasa Titip:</span><span class="text-amber-500">Rp${titipFee.toLocaleString('id-ID')}</span>`; cartItemsDiv.appendChild(feeEl); }
            emptyCartMessage.style.display = hasItems ? 'none' : 'block';
            checkoutButton.style.display = hasItems ? 'block' : 'none';
            cartTotalSpan.textContent = `Rp${total.toLocaleString('id-ID')}`;
        }

        function addItemToCart(itemInfo) {
            const { productId, optionId } = itemInfo;
            const product = allProducts.find(p => p.id === productId); if (!product) return;
            let cartItemId, itemData;
            if (optionId) { 
                const option = product.options.find(o => `${product.id}-${o.id}` === optionId); 
                if (!option) return; 
                cartItemId = optionId; 
                itemData = { id: cartItemId, name: `${product.name} (${option.name})`, price: option.price }; 
            } else { 
                cartItemId = productId; 
                itemData = { id: cartItemId, name: product.name, price: product.price }; 
            }
            cart[cartItemId] ? cart[cartItemId].quantity++ : cart[cartItemId] = { ...itemData, quantity: 1 };
            renderCart();
            showToast(`${itemData.name} berhasil ditambahkan!`);
        }
        
        function renderTestimonials(container) {
            onSnapshot(query(collection(db, 'testimonials')), (snap) => {
                container.innerHTML = ''; 
                snap.docs.forEach(doc => {
                    const t = { id: doc.id, ...doc.data() };
                    const img = document.createElement('img');
                    img.className = 'testimonial-img w-full h-auto object-cover aspect-square rounded-md';
                    img.src = t.url;
                    img.alt = `Testimoni`;
                    img.addEventListener('click', () => {
                        document.getElementById('full-image').src = t.url;
                        showModal(imageModal);
                    });
                    container.appendChild(img);
                });
                testimonialLoadingMessage.classList.add('hidden');
            });
        }
        
        function addTabEventListeners() {
            tabContentContainer.addEventListener('click', e => { if (e.target.matches('.sub-tab-btn')) { const p = e.target.closest('.flex'); p.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); const pane = e.target.closest('.tab-pane'); const baseId = `content-${pane.id.split('-')[1]}`; pane.querySelectorAll('section').forEach(s => s.classList.add('hidden')); document.getElementById(`${baseId}-${e.target.dataset.subcat}`)?.classList.remove('hidden'); } });
        }
        
        function handleAddToCartClick(e) {
            const button = e.target;
            const isMulti = button.matches('.add-to-cart-btn-multi');
            const productId = button.dataset.id;
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            let optionId = null;
            let productName = product.name;

            if (isMulti) {
                const select = document.getElementById(`select-${productId}`);
                optionId = select.value;
                productName = `${product.name} (${select.options[select.selectedIndex].text.split(' - ')[0]})`;
            }
            
            itemToConfirm = { productId, optionId };
            confirmationMessage.innerHTML = `Ingin memasukkan <strong class="text-amber-400">${productName}</strong> ke keranjang?`;
            showModal(confirmationModal);
        }

        // --- Event Listeners ---

        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderUI(allCategories, allProducts);
        });

        tabContentContainer.addEventListener('click', e => {
            if (e.target.matches('.add-to-cart-btn-multi') || e.target.matches('.add-to-cart-btn-single')) {
                handleAddToCartClick(e);
            }
        });
        
        cartItemsDiv.addEventListener('click', e => {
            if (e.target.matches('.remove-from-cart-btn')) {
                const id = e.target.dataset.id;
                if (cart[id]) { 
                    cart[id].quantity > 1 ? cart[id].quantity-- : delete cart[id]; 
                }
                renderCart();
            }
        });
        
        checkoutButton.addEventListener('click', ()=>{ 
            let orderDetails = 'Halo Arunika Shop, saya ingin memesan:\n\n'; 
            let total = 0; 
            Object.values(cart).forEach(item => { 
                const subtotal = item.price*item.quantity; 
                orderDetails += `${item.quantity}x ${item.name} = Rp${subtotal.toLocaleString('id-ID')}\n`; 
                total += subtotal; 
            }); 
            total += titipFee; 
            orderDetails += `\nBiaya Jasa Titip: Rp${titipFee.toLocaleString('id-ID')}\nTotal: Rp${total.toLocaleString('id-ID')}\n\nTerima kasih!`; 
            window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(orderDetails)}`,'_blank'); 
        });

        sendSuggestionBtn.addEventListener('click', () => { const name = document.getElementById('suggestion-item-name').value; const price = document.getElementById('suggestion-item-price').value; if(!name && !price) return; let message = `Halo, saya punya saran barang:\nNama: ${name}\nEstimasi Harga: Rp${price}`; window.open(`https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`, '_blank'); });
        
        function showModal(modal) { modal.classList.add('visible'); }
        function hideModal(modal) { modal.classList.remove('visible'); }
        
        howToOrderBtn.addEventListener('click', () => showModal(howToOrderModal));
        bestSellerInfoBtn.addEventListener('click', () => showModal(bestSellerInfoModal));
        categorySelectorBtn.addEventListener('click', () => showModal(categoryModal));
        
        testimonialBtn.addEventListener('click', () => {
            document.getElementById('testimonial-section').scrollIntoView({ behavior: 'smooth' });
        });

        confirmAddBtn.addEventListener('click', () => {
            if (itemToConfirm) {
                addItemToCart(itemToConfirm);
                itemToConfirm = null;
            }
            hideModal(confirmationModal);
        });
        cancelAddBtn.addEventListener('click', () => hideModal(confirmationModal));

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) { 
                    hideModal(modal);
                }
            });
        });
        document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', (e) => { hideModal(e.target.closest('.modal-overlay')); }));

        onSnapshot(query(collection(db, 'jastip_categories'), orderBy('order')), (catSnap) => {
            allCategories = catSnap.docs.map(doc => doc.data());
            // Menggunakan query dengan orderBy nama sebagai default
            onSnapshot(query(collection(db, 'products'), orderBy('name')), (prodSnap) => {
                allProducts = prodSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI(allCategories, allProducts);
            });
        });
        
        renderTestimonials(testimonialGrid);
        renderCart();
    </script>
</body>
</html>
